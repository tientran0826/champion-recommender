services:
  minio:
    image: minio/minio
    container_name: minio_storage
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
    - MINIO_ROOT_USER=admin
    - MINIO_ROOT_PASSWORD=admin1234
    volumes:
      - ./storage/minio:/data
    command: server --console-address ":9001" /data
    networks:
      - dagster_net

  createbuckets:
    image: minio/mc
    depends_on:
      - minio
    entrypoint: >
      /bin/sh -c "
        sleep 5 &&
        mc alias set rcm_minio http://minio:9000 admin admin1234 &&
        mc mb rcm_minio/data-lakehouse &&
        mc anonymous set public rcm_minio/data-lakehouse
      "
    networks:
      - dagster_net

  postgres:
    image: postgres:13
    container_name: shared_postgres
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: "postgres"
      POSTGRES_PASSWORD: "postgres"
      POSTGRES_DB: "postgres"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./sql/init-db-postgres.sql:/docker-entrypoint-initdb.d/init-db.sql
    networks:
      - dagster_net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 8s
      retries: 5

  dagster:
    build:
      context: .
      dockerfile: Dockerfile_dagster
    container_name: dagster
    ports:
      - "3000:3000"
    environment:
      - DAGSTER_HOME=/opt/dagster/dagster_home/
      - PYTHONPATH=/opt/dagster/
      - DAGSTER_POSTGRES_USER=dagster
      - DAGSTER_POSTGRES_PASSWORD=dagster
      - DAGSTER_POSTGRES_DB=dagster_db
      - DAGSTER_POSTGRES_HOST=shared_postgres
      - DAGSTER_POSTGRES_PORT=5432
      - FASTAPI_HOST=model_api
    volumes:
      - ./dagster_home:/opt/dagster/dagster_home/
      - ./.env:/opt/dagster/dagster_home/.env   # <- now relative path works
      - ./settings.py:/opt/dagster/settings.py
    command: dagster-webserver -h 0.0.0.0 -p 3000
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - dagster_net
  dagster-daemon:
    build:
      context: .
      dockerfile: Dockerfile_dagster
    container_name: dagster-daemon
    environment:
      - DAGSTER_HOME=/opt/dagster/dagster_home/
      - PYTHONPATH=/opt/dagster/
      - DAGSTER_POSTGRES_USER=dagster
      - DAGSTER_POSTGRES_PASSWORD=dagster
      - DAGSTER_POSTGRES_DB=dagster_db
      - DAGSTER_POSTGRES_HOST=shared_postgres
      - DAGSTER_POSTGRES_PORT=5432
      - S3_ENDPOINT=minio:9000
      - TRINO_HOST=trino
      - FASTAPI_HOST=http://model_api:8000
    volumes:
      - ./dagster_home:/opt/dagster/dagster_home/
      - ./.env:/opt/dagster/dagster_home/.env   # <- now relative path works
      - ./settings.py:/opt/dagster/settings.py
    command: dagster-daemon run
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - dagster_net

  model_api:
    build:
      context: .
      dockerfile: Dockerfile_model_api
    container_name: model_api
    ports:
      - "8000:8000"
    environment:
      - S3_ENDPOINT=minio:9000
      - S3_ACCESS_KEY=admin
      - S3_SECRET_KEY=admin1234
      - TRINO_HOST=trino
      - MLFLOW_S3_ENDPOINT_URL=http://minio:9000
      - MLFLOW_BACKEND_STORE_URI=http://mlflow:5000
    depends_on:
      minio:
        condition: service_started
      trino:
        condition: service_healthy
    networks:
      - dagster_net
  frontend:
    build:
      context: .
      dockerfile: Dockerfile_fe
    container_name: frontend
    ports:
      - "80:8005"
    depends_on:
      trino:
        condition: service_healthy
    networks:
      - dagster_net
    environment:
      - FASTAPI_HOST=http://model_api:8000
      - TRINO_HOST=trino
  mlflow:
    build:
      context: .
      dockerfile: Dockerfile_mlflow
    command: >
      mlflow server
      --host 0.0.0.0
      --port 5000
      --backend-store-uri postgresql://mlflow:mlflow@postgres/mlflow_db
      --default-artifact-root s3://data-lakehouse/mlflow/artifacts
      --allowed-hosts="*"
      --cors-allowed-origins="*"
    environment:
      MLFLOW_BACKEND_STORE_URI: postgresql://mlflow:mlflow@postgres/mlflow_db
      S3_ENDPOINT : http://minio:9000
      AWS_ACCESS_KEY_ID: admin
      AWS_SECRET_ACCESS_KEY: admin1234
      MLFLOW_S3_ENDPOINT_URL: minio:9000
    depends_on:
      postgres:
        condition: service_healthy
      minio:
        condition: service_started
    ports:
      - "5000:5000"
    networks:
      - dagster_net

  hive-metastore:
    image: 'starburstdata/hive:3.1.2-e.18'
    hostname: hive-metastore
    container_name: hive_metastore
    ports:
      - '9083:9083'
    restart: always
    environment:
      # Use shared PostgreSQL for Hive Metastore
      HIVE_METASTORE_DRIVER: org.postgresql.Driver
      HIVE_METASTORE_JDBC_URL: jdbc:postgresql://postgres:5432/metastore
      HIVE_METASTORE_USER: hive
      HIVE_METASTORE_PASSWORD: hive

      HIVE_METASTORE_WAREHOUSE_DIR: s3a://data-lakehouse/

      S3_ENDPOINT: http://minio:9000
      S3_ACCESS_KEY: admin
      S3_SECRET_KEY: admin1234
      S3_PATH_STYLE_ACCESS: "true"
      REGION: ""

      GOOGLE_CLOUD_KEY_FILE_PATH: ""
      AZURE_ADL_CLIENT_ID: ""
      AZURE_ADL_CREDENTIAL: ""
      AZURE_ADL_REFRESH_URL: ""
      AZURE_ABFS_STORAGE_ACCOUNT: ""
      AZURE_ABFS_ACCESS_KEY: ""
      AZURE_WASB_STORAGE_ACCOUNT: ""
      AZURE_ABFS_OAUTH: ""
      AZURE_ABFS_OAUTH_TOKEN_PROVIDER: ""
      AZURE_ABFS_OAUTH_CLIENT_ID: ""
      AZURE_ABFS_OAUTH_SECRET: ""
      AZURE_ABFS_OAUTH_ENDPOINT: ""
      AZURE_WASB_ACCESS_KEY: ""
      HIVE_METASTORE_USERS_IN_ADMIN_ROLE: "admin"
    depends_on:
      postgres:
        condition: service_healthy
      minio:
        condition: service_started
    healthcheck:
      test: bash -c "exec 6<> /dev/tcp/localhost/9083"
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - dagster_net

  trino:
    image: 'trinodb/trino:400'
    container_name: trino
    ports:
      - "8080:8080"
    volumes:
      - ./trino/etc:/etc/trino
    depends_on:
      hive-metastore:
        condition: service_healthy
      minio:
        condition: service_started
    networks:
      - dagster_net
    healthcheck:
      test: ["CMD", "trino", "--server", "localhost:8080", "--catalog", "system", "--schema", "runtime", "--execute", "SELECT 1"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 60s

  trino-init:
    image: trinodb/trino:400
    container_name: trino_init
    depends_on:
      trino:
        condition: service_healthy
    entrypoint: /bin/bash
    command: >
      -c "
      echo 'Waiting for Trino...' &&
      for i in {1..30}; do
        trino --server trino:8080 --catalog system --schema runtime --execute 'SELECT 1' && break || sleep 2;
      done &&
      trino --server trino:8080 --user admin --execute \"SHOW CATALOGS\" &&
      trino --server trino:8080 --user admin -f /init/define-schemas-trino.sql
      "
    volumes:
      - ./sql:/init
    networks:
      - dagster_net

volumes:
  postgres_data:

networks:
  dagster_net:
